<article>
{{#claims}}
<h1>Hei {{.sub}} üëã</h1>
{{/claims}}
{{^claims}}
<h1>Ikke innlogget</h1>
{{/claims}}

{{#is_uploader?}}
<form id="uploader-form">
<input class="uploader-form--file-input" id="image" name="image" required type="file" accept="image/jpeg">
<img class="uploader-form--preview" src="" alt="preview">
<div class="uploader-form--phase-initial">
<label class="uploader-form--link" for="image">Last opp et bilde</label>
</div>
<div class="uploader-form--phase-preview">
<div class="uploader-form--controls">
    <p>Vil du laste opp dette bildet?</p>
    <p>
        <label class="uploader-form--button uploader-form--button__negative" for="image">‚ùå Nei, et annet</label>
        <button class="uploader-form--button uploader-form--button__default" type="submit">‚úî Ja, dette</button>
    </p>
    <p>
        <button class="uploader-form--link" type="reset">Nei, glem hele opplastingen</button>
    </p>
</div>
</div>
<div class="uploader-form--upload-error">
    <p>üíÅ Noe gikk galt med opplastingen. <span class="uploader-form--error-message"></span></p>
    <p><button class="uploader-form--button uploader-form--button__default" type="submit">Pr√∏v igjen</button></p>
    <p><button class="uploader-form--link" type="reset">Nei, glem hele opplastingen</button></p>
</div>
</form>

<script>
// The uploader will work with JS only. Too much mucking about to parse
// multipart messages.

var form = document.getElementById('uploader-form');
var fileInput = form.querySelector('input[type="file"]');
var preview = form.querySelector('.uploader-form--preview');

var PHASE_INITIAL = 0;
var PHASE_PREVIEW = 1;
var PHASE_DETAILS = 2;

var UPLOAD_PHASE_INACTIVE = 0;
var UPLOAD_PHASE_IN_PROGRESS = 1;
var UPLOAD_PHASE_FINISHED = 2;

var UPLOAD_STATE_FAILURE = false;
var UPLOAD_STATE_SUCCESS = true;

var UPLOAD_ERROR_TRY_AGAIN = "Pr√∏v igjen ü§∑";
var UPLOAD_ERROR_CHECK_CONNECTIVITY = "ü§î Er du tilkoblet Internett?";

var initialState = {
    phase: PHASE_INITIAL,
    uploadPhase: UPLOAD_PHASE_INACTIVE,
};
var state = initialState;

function setState(newState) {
    console.log(newState);

    if (newState.phase != state.phase) {
        document.querySelector('.uploader-form--phase-initial').style.display =
            (newState.phase == PHASE_INITIAL ? 'block' : 'none');
        document.querySelector('.uploader-form--phase-preview').style.display =
            (newState.phase == PHASE_PREVIEW ? 'block' : 'none');

        var oldShowPreview = state.phase >= PHASE_PREVIEW;
        var newShowPreview = newState.phase >= PHASE_PREVIEW;
        if (newShowPreview != oldShowPreview) {
            preview.style.display = newShowPreview ? "block" : "none";
        }
    }

    if (newState.file != state.file) {
        preview.src = newState.file ? window.URL.createObjectURL(newState.file) : "";
    }

    if (newState.uploadError != state.uploadError) {
        if (newState.uploadError) {
            document.querySelector('.uploader-form--error-message').textContent =
                newState.uploadError.hint;
        }

        document.querySelector('.uploader-form--upload-error').style.display =
            newState.uploadError ? 'block' : 'none';
    }

    state = newState;
}

function updateState(delta) {
    var newState = { ...state, ...delta };
    setState(newState);
}

var actions = {
    selectFile: function (file) {
        updateState({
            phase: file ? PHASE_PREVIEW : PHASE_INITIAL,
            file: file || null,
        });
    },
    reset: function () {
        setState(initialState);
    },
    upload: function (file) {
        fetch('img/', {
            method: 'POST',
            body: file,
            credentials: 'same-origin',
            redirect: 'follow',
        })
        .catch(function (err) {
            // Low level error situation, such as network error
            throw {
                err: err,
                hint: UPLOAD_ERROR_CHECK_CONNECTIVITY,
            };
        })
        .then(function (res) {
            try {
                if (!res.ok) {
                    throw "Unexpected status code: " + res.status + " " + res.statusText;
                }

                var location = res.headers.get('location');
                if (!location) {
                    throw "Missing Location header in server response";
                }

                actions.uploadFinished(location);
            }
            catch (err) {
                // Unexpected error
                throw {
                    err: err,
                    hint: UPLOAD_ERROR_TRY_AGAIN,
                };
            }
        })
        .catch(function (err) {
            updateState({
                uploadPhase: UPLOAD_PHASE_FINISHED,
                uploadResult: UPLOAD_STATE_FAILURE,
                uploadError: err,
            });
        });

        updateState({
            phase: PHASE_DETAILS,
            uploadPhase: UPLOAD_PHASE_IN_PROGRESS,
            uploadResult: null,
            uploadLocation: null,
            uploadError: null,
        });
    },
    uploadFinished: function (location) {
        updateState({
            uploadPhase: UPLOAD_PHASE_FINISHED,
            uploadResult: UPLOAD_STATE_SUCCESS,
            uploadLocation: location,
        });
    }
};

fileInput.addEventListener('change', function (ev) {
    ev.preventDefault();
    ev.stopPropagation();
    actions.selectFile(fileInput.files[0]);
});

form.addEventListener('reset', function (ev) {
    actions.reset();
});

form.addEventListener('submit', function (ev) {
    ev.preventDefault();
    ev.stopPropagation();
    actions.upload(state.file);
});

actions.selectFile(fileInput.files[0]);

</script>
{{/is_uploader}}

{{#authorized_pixurs?}}
<p>Her er bildene vi har delt med deg</p>
<ul class="thumbnails">
{{#authorized_pixurs}}
    <li class="thumbnails--item"><a class="thumbnails--link" href="{{.0}}"><img class="thumbnails--thumbnail" src="thumb/{{.1}}" alt="Pixur {{.0}}"></a></li>
{{/authorized_pixurs}}
</ul>
</article>
{{/authorized_pixurs}}
