<article>
{{#claims}}
<h1>Hei {{.sub}} üëã</h1>
{{/claims}}
{{^claims}}
<h1>Ikke innlogget</h1>
{{/claims}}

{{#is_uploader?}}
<form id="uploader-form">
<input class="uploader-form--file-input" id="image" name="image" required type="file" accept="image/jpeg">
<img class="uploader-form--preview" src="" alt="preview">
<div class="uploader-form--phase-1">
<label class="uploader-form--link" for="image">Last opp et bilde</label>
</div>
<div class="uploader-form--phase-2">
<div class="uploader-form--controls">
    <p>Vil du laste opp dette bildet?</p>
    <p>
        <label class="uploader-form--button uploader-form--button__negative" for="image">‚ùå Nei, et annet</label>
        <button class="uploader-form--button uploader-form--button__default" type="submit">‚úî Ja, dette</button>
    </p>
    <p>
        <button class="uploader-form--link" type="reset">Nei, glem hele opplastingen</button>
    </p>
</div>
</div>
</form>

<script>
// The uploader will work with JS only. Too much mucking about to parse
// multipart messages.

var form = document.getElementById('uploader-form');
var fileInput = form.querySelector('input[type="file"]');
var preview = form.querySelector('.uploader-form--preview');

var PHASE_INITIAL = 0;
var PHASE_PREVIEW = 1;
var PHASE_DETAILS = 2;

var UPLOAD_PHASE_INACTIVE = 0;
var UPLOAD_PHASE_IN_PROGRESS = 1;
var UPLOAD_PHASE_FINISHED = 2;

var UPLOAD_STATE_FAILURE = true;
var UPLOAD_STATE_SUCCESS = true;

var state = {
    phase: PHASE_INITIAL,
    uploadPhase: UPLOAD_PHASE_INACTIVE,
};

function setState(newState) {
    console.log(newState);

    if (newState.phase != state.phase) {
        document.querySelector('.uploader-form--phase-1').style.display =
            (newState.phase == PHASE_INITIAL ? 'block' : 'none');
        document.querySelector('.uploader-form--phase-2').style.display =
            (newState.phase == PHASE_PREVIEW ? 'block' : 'none');

        var oldShowPreview = state.phase >= PHASE_PREVIEW;
        var newShowPreview = newState.phase >= PHASE_PREVIEW;
        if (newShowPreview != oldShowPreview) {
            preview.style.display = newShowPreview ? "block" : "none";
        }
    }

    if (newState.file != state.file) {
        preview.src = newState.file ? window.URL.createObjectURL(newState.file) : "";
    }

    state = newState;
}

function updateState(delta) {
    var newState = { ...state, ...delta };
    setState(newState);
}

var actions = {
    selectFile: function (file) {
        updateState({
            phase: file ? PHASE_PREVIEW : PHASE_INITIAL,
            file: file || null,
        });
    },
    upload: function (file) {
        fetch('img/', {
            method: 'POST',
            body: file,
        })
        .then(function (res) {
            updateState({
                uploadPhase: UPLOAD_PHASE_FINISHED,
                uploadResult: UPLOAD_STATE_SUCCESS,
            });
        })
        .catch(function (err) {
            updateState({
                uploadPhase: UPLOAD_PHASE_FINISHED,
                uploadResult: UPLOAD_STATE_FAILURE,
            });
        });

        updateState({
            phase: PHASE_DETAILS,
            uploadPhase: UPLOAD_PHASE_IN_PROGRESS,
        });
    },
};

fileInput.addEventListener('change', function (ev) {
    ev.preventDefault();
    ev.stopPropagation();
    actions.selectFile(fileInput.files[0]);
});

form.addEventListener('reset', function (ev) {
    actions.selectFile(null);
});

form.addEventListener('submit', function (ev) {
    ev.preventDefault();
    ev.stopPropagation();
    actions.upload(state.file);
});

actions.selectFile(fileInput.files[0]);

</script>
{{/is_uploader}}

{{#authorized_pixurs?}}
<p>Her er bildene vi har delt med deg</p>
<ul class="thumbnails">
{{#authorized_pixurs}}
    <li class="thumbnails--item"><a class="thumbnails--link" href="{{.0}}"><img class="thumbnails--thumbnail" src="thumb/{{.1}}" alt="Pixur {{.0}}"></a></li>
{{/authorized_pixurs}}
</ul>
</article>
{{/authorized_pixurs}}
